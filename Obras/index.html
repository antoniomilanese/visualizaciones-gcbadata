<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Mapa de Obras en GCBA</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/carto-gcba.css" rel="stylesheet">  
    <link rel="stylesheet" href="css/leaflet.css" / > 
    <!--[if IE]><link rel="stylesheet" href="css/leaflet.ie.css" /><![endif]-->
    <link  href="css/cartodb-leaflet.css" rel="stylesheet" type="text/css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/wax.leaf.min.js"></script>
    <script type="text/javascript" src="dist/cartodb-leaflet-min.js"></script>
    <script type="text/javascript" src="dist/cartodb-popup-min.js"></script> 
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>

    <script type="text/javascript">

    	var puntos, map;
      var tipo = '';
      var estado = '';
  	  function initialize() {
  			map = new L.Map('map_canvas').setView(new L.LatLng(-34.618234674892, -58.404178619384766), 12);

        //var mapboxUrl = 'http://a.tiles.mapbox.com/v3/mapbox.mapbox-streets/{z}/{x}/{y}.png',
        var mapboxUrl = 'https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png',
            mapbox = new L.TileLayer(mapboxUrl, {maxZoom: 17,attribution:"Powered by Leaflet and Mapbox"});
        map.addLayer(mapbox,true);
              

    		var query="SELECT * FROM obras_2013";
        var popup = new L.CartoDBPopup();
        var circleMarker = {};
        var hover_style = {radius:4, color:"#333", weight:2, opacity:1, fillColor: "#FFCC00", fillOpacity:0, clickable:false};
          
          
        puntos = new L.CartoDBLayer({
          map: map,
          user_name:'antoniomilanese',
          extra_params:{v:4},
          cdn_url:'',
          table_name: 'obras_2013',
          query: query,
          interactivity: "cartodb_id,tipo,x,y,estado",
          featureOver: function(ev,latlng,pos,data) {
            document.body.style.cursor = "pointer";
            showTooltip(data,pos)
            
            // Show the hover point if it is a different feature
            if (data.cartodb_id != circleMarker.cartodb_id) {
              map.removeLayer(circleMarker);
            
              circleMarker = new L.CircleMarker(new L.LatLng(data.x, data.y), hover_style);
              circleMarker.cartodb_id = data.cartodb_id;
              
              map.addLayer(circleMarker);
            }
            
          },
          featureOut: function() {
            document.body.style.cursor = "default";
            hideTooltip();
            
            // Hide and remove in any case the hover point
            circleMarker.cartodb_id = null;
            map.removeLayer(circleMarker)
          },
          featureClick: function(ev,latlng,pos,data) {
              window.open(data["link"],"_blank");
              
          },
          auto_bound: false
        });

        map.addLayer(puntos)
  	  }

      function showTooltip(data,point) {
        var html = "";
        
        html += "<h3>" + data["nombre"] +"</label>";
        
        
        html += "<br><label>Tipo</label><p>" + data["tipo"] +"</p>";
        html += "<br><label>Tematica</label><p>" + data["tematica"] +"</p>";
        html += "<br><label>Ubiaci√≥n</label><p>" + data["ubicacion"] +"</p>";
        html += "<br><label>Barrio</label><p>" + data["barrio"] +"</p>";
        
        $("#tooltip").html(html);
        $("#tooltip").css({left: (point.x + 15) + 'px', top: point.y - ($("#tooltip").height()) + 10 + 'px'})
        $("#tooltip").show();
      }

      function hideTooltip() {
        $("#tooltip").hide();
      }
      

      function changeTipo(new_tipo) {
          tipo = new_tipo
          changeButtonTipo(tipo)
          changeLayer()
      }

      function changeEstado(new_estado) {
          estado = new_estado
          changeButtonEstado(estado)
          changeLayer()
      }

      function changeButtonTipo(new_tipo){
        if (new_tipo == '') {
          new_tipo = 'ALLTIPO'
        }
        cleanButtonTipo()
        document.getElementById(new_tipo).className = "btn btn-primary"; 
      }

      function changeButtonEstado(new_estado){
        if (new_estado == '') {
          new_estado = 'ALLESTADO'
        }
        cleanButtonEstado()
        document.getElementById(new_estado).className = "btn btn-primary"; 
      }

      function cleanButtonTipo() {
        document.getElementById('ALLTIPO').className = "btn";
        document.getElementById('PARCELA').className = "btn";
        document.getElementById('VEREDA').className = "btn";
        document.getElementById('CALLE').className = "btn";
      }

      function cleanButtonEstado() {
        document.getElementById('ALLESTADO').className = "btn";
        document.getElementById('EJEC').className = "btn";
        document.getElementById('DENE').className = "btn";
        document.getElementById('VERI').className = "btn";
      }
  	  
      function changeLayer() {
        if (tipo == '' && estado == '') {
            puntos.setQuery("SELECT * FROM obras_2013");
        } else if (tipo == '' && estado != '') {
            puntos.setQuery("SELECT * FROM obras_2013 WHERE estado = '" + estado + "'"); 
        } else if (tipo != '' && estado == '') {
            puntos.setQuery("SELECT * FROM obras_2013 WHERE tipo = '" + tipo + "'");
        } else if ( tipo != '' && estado != '') {
            puntos.setQuery("SELECT * FROM obras_2013 WHERE estado = '" + estado + "' AND tipo = '" + tipo +"'");
        }
      }
    </script>

  </head>
  <body onload="initialize()">
    
    <div id="map_canvas"></div>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
          <a class="brand" href="#">Obras en GCBA</a>
          <div class="btn-group pull-right">
          <div class="btn-group">
            <button id="ALLTIPO" class="btn btn-primary" onClick="changeTipo('')" type="button">Ver todas</button>
            <button id="CALLE" class="btn" onClick="changeTipo('CALLE')" type="button">CALLE</button>
            <button id="VEREDA" class="btn" onClick="changeTipo('VEREDA')" type="button">VEREDA</button>
            <button id="PARCELA" class="btn" onClick="changeTipo('PARCELA')" type="button">PARCELA</button>
          </div>

          <div class="btn-group">
            <button id="ALLESTADO" class="btn btn-primary" onClick="changeEstado('')" type="button">Ver todas</button>
            <button id="EJEC" class="btn" onClick="changeEstado('EJEC')" type="button">EJEC</button>
            <button id="DENE" class="btn" onClick="changeEstado('DENE')" type="button">DENE</button>
            <button id="VERI" class="btn" onClick="changeEstado('VERI')" type="button">VERI</button>
        </div>
      </div>
      </div>
    </div>


    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-tab.js"></script>
    <script src="js/bootstrap-tooltip.js"></script>
  </body>
</html>

